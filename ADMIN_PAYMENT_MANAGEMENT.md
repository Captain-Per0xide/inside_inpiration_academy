# Admin Payment Management System

## Overview

The admin payment management system allows administrators to configure payment information that will be used across the application for student payments. This includes UPI ID, phone number, and QR code image management.

## Database Schema

### payment_info Table

```sql
CREATE TABLE public.payment_info (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  phone_number text not null,
  upi_id text not null,
  qr_code text not null,
  constraint payment_info_pkey primary key (id)
);
```

**Columns:**

- `id`: Auto-incrementing primary key
- `created_at`: Timestamp of when the record was created
- `phone_number`: Phone number for Google Pay/PhonePe payments
- `upi_id`: UPI ID for payments (e.g., user@paytm)
- `qr_code`: Public URL of the uploaded QR code image

## Features

### 1. Payment Information Management

- **Create/Update**: Admins can create new or update existing payment information
- **QR Code Upload**: Upload QR code images with automatic storage management
- **Form Validation**: Comprehensive validation for all input fields
- **Responsive Design**: Works across mobile, tablet, and desktop devices

### 2. QR Code Image Management

- **Storage Path**: `Payment-Info/qr.png` in the `inside-inspiration-academy-assets` bucket
- **Image Processing**: Uses the same upload logic as profile images
- **File Replacement**: Automatically removes old QR codes when uploading new ones
- **Public URL Generation**: Automatically generates and stores public URLs

### 3. Integration with Payment Component

- **Dynamic Loading**: Payment component fetches current payment info from database
- **Fallback Values**: Graceful fallback to default values if no payment info is configured
- **Real-time Updates**: Changes in admin panel immediately reflect in payment forms

## File Structure

```
app/
├── (admin)/
│   └── payment.tsx          # Admin payment management interface
└── components/
    └── payment.tsx          # Student payment component (updated to use dynamic data)
database/
└── payment_info_table.sql   # Database schema and policies
```

## API Endpoints (Supabase)

### Fetch Payment Info

```typescript
const { data, error } = await supabase
  .from("payment_info")
  .select("*")
  .order("created_at", { ascending: false })
  .limit(1)
  .maybeSingle();
```

### Insert Payment Info

```typescript
const { error } = await supabase.from("payment_info").insert([
  {
    phone_number: phoneNumber.trim(),
    upi_id: upiId.trim(),
    qr_code: qrCodeUrl,
  },
]);
```

### Update Payment Info

```typescript
const { error } = await supabase
  .from("payment_info")
  .update({
    phone_number: phoneNumber.trim(),
    upi_id: upiId.trim(),
    qr_code: qrCodeUrl,
  })
  .eq("id", paymentInfo.id);
```

## Storage Management

### QR Code Upload Process

1. **File Selection**: Admin selects QR code image using image picker
2. **Old File Removal**: System removes existing `Payment-Info/qr.png` if it exists
3. **Image Conversion**: Convert image URI to ArrayBuffer using FileSystem
4. **Upload**: Upload to Supabase storage with upsert option
5. **URL Generation**: Get public URL and store in database

### Storage Path Structure

```
inside-inspiration-academy-assets/
└── Payment-Info/
    └── qr.png              # Always named qr.png (overwritten on update)
```

## Security

### Row Level Security (RLS)

- **Admin Access**: Admins can read and write all payment info
- **Public Read**: Anyone can read payment info (needed for payment forms)
- **No Anonymous Write**: Only authenticated admins can modify payment info

### Policies

```sql
-- Admin can manage payment info
CREATE POLICY "Admin can manage payment info" ON public.payment_info
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM public.users
    WHERE users.id = auth.uid()
    AND users.role = 'admin'
  )
);

-- Anyone can read payment info
CREATE POLICY "Anyone can read payment info" ON public.payment_info
FOR SELECT USING (true);
```

## Usage

### For Admins

1. Navigate to Admin Panel → Payment Management
2. Fill in phone number and UPI ID
3. Upload QR code image
4. Click "Save Information" or "Update Information"
5. Changes are immediately available to students

### For Students

- Payment forms automatically load current payment information
- QR code, UPI ID, and phone number are dynamically populated
- Fallback to default values if no admin configuration exists

## Error Handling

### Admin Panel

- Form validation for required fields
- Image upload error handling
- Database operation error handling
- User-friendly error messages

### Payment Component

- Graceful handling of missing payment info
- Fallback to default values
- Non-blocking errors for payment info fetch failures

## Responsive Design

### Breakpoints

- **Small Screen** (`< 600px`): Mobile layout with adjusted font sizes and spacing
- **Medium Screen** (`600px - 900px`): Tablet layout
- **Large Screen** (`> 900px`): Desktop layout

### Image Sizing

- QR code images scale based on screen size
- Preview images maintain aspect ratio
- Touch-friendly button sizing on mobile

## Future Enhancements

1. **Multiple Payment Methods**: Support for multiple UPI IDs or payment methods
2. **Payment Analytics**: Track payment method usage
3. **Bulk Operations**: Batch updates for payment information
4. **Version History**: Track changes to payment information over time
5. **Approval Workflow**: Require approval for payment info changes

## Testing

### Test Cases

1. **Create Payment Info**: First-time setup of payment information
2. **Update Payment Info**: Modify existing payment information
3. **QR Code Upload**: Upload and replace QR code images
4. **Form Validation**: Test validation for all required fields
5. **Integration**: Verify payment component uses updated information
6. **Responsive**: Test across different screen sizes
7. **Error Scenarios**: Test error handling for various failure cases

### Manual Testing Steps

1. Access admin panel as admin user
2. Try creating payment info without filling required fields (should show validation errors)
3. Fill all fields and upload QR code
4. Verify information is saved correctly
5. Navigate to guest payment page and verify updated information appears
6. Update payment info and verify changes reflect immediately
7. Test on different screen sizes
